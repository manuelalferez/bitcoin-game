<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bitcoin Trading Game</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #1a1a1a;
        color: #fff;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }
      #game-container,
      #welcome-screen {
        text-align: center;
        background: #242424;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      #bitcoin-chart {
        margin: 20px 0;
        background: #2d2d2d;
        padding: 1rem;
        border-radius: 8px;
      }
      .hidden {
        display: none;
      }
      button {
        background: #f7931a;
        color: white;
        border: none;
        padding: 12px 24px;
        margin: 8px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
      }
      button:hover {
        background: #e88a16;
      }
      button:disabled {
        background: #666;
        cursor: not-allowed;
      }
      input {
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #444;
        background: #333;
        color: white;
        margin: 10px 0;
        width: 200px;
      }
      .price-display {
        font-size: 2.5rem;
        font-weight: bold;
        color: #f7931a;
        margin: 1rem 0;
      }
      .balance-display {
        background: #2d2d2d;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
      }
      .trading-controls {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin: 1rem 0;
      }
      .trading-section {
        background: #2d2d2d;
        padding: 1rem;
        border-radius: 8px;
      }
      .price-holdings-container {
        display: flex;
        justify-content: center;
        gap: 2rem;
      }
      .price-holdings-container .balance-display {
        flex: 1;
        max-width: 400px;
      }
      .holdings-details {
        font-size: 1.3rem;
        color: #aaa;
        margin-top: 0.75rem;
        padding: 0.5rem;
        border-left: 3px solid #f7931a;
        background: rgba(247, 147, 26, 0.05);
        border-radius: 4px;
        transition: all 0.2s ease;
      }
      .holdings-details:hover {
        background: rgba(247, 147, 26, 0.1);
        transform: translateX(1px);
      }
      .fa-icon {
        margin-right: 8px;
      }
      .progress-container {
        background: #2d2d2d;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
      }
      .progress-bar {
        width: 100%;
        height: 24px;
        background: #333;
        border-radius: 12px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background: #f7931a;
        transition: width 0.3s ease;
      }
      .progress-text {
        margin-top: 0.5rem;
        font-size: 1.2rem;
        color: #888;
      }
      .player-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin: 20px auto 10px;
        border: 4px solid #f7931a;
        box-shadow: 0 4px 8px rgba(247, 147, 26, 0.3);
      }
      .player-name {
        font-size: 1.8rem;
        font-weight: bold;
        color: #f7931a;
        margin: 10px 0 20px;
      }
      .welcome-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .history-container {
        background: #2d2d2d;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
      }
      .history-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      .history-table th,
      .history-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #444;
      }
      .history-table th {
        background: #1a1a1a;
        color: #f7931a;
      }
      .history-table tr:hover {
        background: rgba(247, 147, 26, 0.05);
      }
      .gain-positive {
        color: #00ff00;
      }
      .gain-negative {
        color: #ff0000;
      }
      .holdings-details {
        background: rgba(247, 147, 26, 0.1);
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
      }
      .holdings-box {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .holdings-value,
      .holdings-gain {
        background: #242424;
        padding: 8px;
        border-radius: 8px;
      }
      .holdings-value h4,
      .holdings-gain h4 {
        font-size: 1.2rem;
        color: #aaa;
        margin: 0 0 6px 0;
      }
      .holdings-value div,
      .holdings-gain div {
        font-size: 2.5rem;
        font-weight: bold;
        color: #f7931a;
      }
      .fa-icon {
        margin-right: 8px;
        color: #f7931a;
      }
      .gain-loss.positive {
        color: #00ff00;
      }
      .gain-loss.negative {
        color: #ff0000;
      }
    </style>
  </head>
  <body>
    <div id="welcome-screen">
      <h1><i class="fa-solid fa-rocket fa-icon"></i>Bitcoin Trading Game</h1>
      <input type="text" id="player-name" placeholder="Enter your name" />
      <h3><i class="fa-solid fa-trophy fa-icon"></i>Choose your goal:</h3>
      <button onclick="startGame('10K')">
        <i class="fa-solid fa-coins fa-icon"></i>$10,000 Goal
      </button>
      <button onclick="startGame('100K')">
        <i class="fa-solid fa-coins fa-icon"></i>$100,000 Goal
      </button>
      <button onclick="startGame('1M')">
        <i class="fa-solid fa-coins fa-icon"></i>$1,000,000 Goal
      </button>
    </div>

    <div id="game-container" class="hidden">
      <div class="welcome-header">
        <img
          id="game-avatar"
          class="player-avatar"
          src=""
          alt="Player Avatar"
        />
        <div class="player-name" id="name-display"></div>
      </div>
      <div class="progress-container">
        <h3><i class="fa-solid fa-bullseye fa-icon"></i>Progress to Goal</h3>
        <div class="progress-bar">
          <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
        </div>
        <div class="progress-text">
          $<span id="current-amount">0</span> / $<span id="goal-display"></span>
        </div>
      </div>
      <div class="balance-display">
        <h3><i class="fa-solid fa-wallet fa-icon"></i>Current Balance</h3>
        <div class="price-display">$<span id="balance-display"></span></div>
      </div>
      <div class="price-holdings-container">
        <div class="balance-display">
          <h3><i class="fa-brands fa-bitcoin fa-icon"></i>Bitcoin Price</h3>
          <div class="price-display">
            $<span id="current-price-display"></span>
          </div>
        </div>
        <div class="balance-display">
          <h3>
            <i class="fa-solid fa-chart-pie fa-icon"></i>Your Bitcoin Holdings
          </h3>
          <div class="price-display"><span id="btc-holdings">0</span> BTC</div>
          <div class="holdings-details">
            <div class="holdings-box">
              <div class="holdings-value">
                <h6 style="margin-bottom: 0">
                  <i class="fa-solid fa-sack-dollar fa-icon"></i>Current Value:
                </h6>
                <div>
                  <small style="font-size: 0.5em">
                    $<span id="holdings-value">0</span>
                  </small>
                </div>
              </div>
              <div class="holdings-gain">
                <h6 style="margin-bottom: 0">
                  <i class="fa-solid fa-chart-line fa-icon"></i>Total
                  Profit/Loss:
                </h6>
                <div>
                  <small style="font-size: 0.5em">
                    <span id="holdings-gain" class="gain-loss">0</span>
                  </small>
                </div>
              </div>
            </div>
            <script>
              // Add positive/negative class based on value
              const gainLossSpan = document.getElementById("holdings-gain");
              const observer = new MutationObserver(() => {
                const value = parseFloat(
                  gainLossSpan.textContent.replace(/[^-\d.]/g, "")
                );
                gainLossSpan.classList.remove("positive", "negative");
                if (value > 0) gainLossSpan.classList.add("positive");
                if (value < 0) gainLossSpan.classList.add("negative");
              });
              observer.observe(gainLossSpan, { childList: true });
            </script>
          </div>
        </div>
      </div>
      <canvas id="bitcoin-chart"></canvas>

      <div class="trading-controls">
        <div class="trading-section">
          <h3><i class="fa-solid fa-cart-shopping fa-icon"></i>Buy Bitcoin</h3>
          <input
            type="number"
            id="buy-amount"
            min="0"
            step="0.01"
            placeholder="USD Amount"
          />
          <button onclick="buyBitcoin()">
            <i class="fa-solid fa-circle-plus fa-icon"></i>Buy BTC
          </button>
        </div>
        <div class="trading-section">
          <h3><i class="fa-solid fa-store fa-icon"></i>Sell Bitcoin</h3>
          <button onclick="sellAllBitcoin()" id="sell-button">
            <i class="fa-solid fa-circle-minus fa-icon"></i>Sell All BTC
          </button>
        </div>
      </div>

      <div class="history-container">
        <h3>
          <i class="fa-solid fa-clock-rotate-left fa-icon"></i>Trading History
        </h3>
        <table class="history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Amount (BTC)</th>
              <th>Price</th>
              <th>Total (USD)</th>
              <th>Gain/Loss</th>
            </tr>
          </thead>
          <tbody id="history-tbody"></tbody>
        </table>
      </div>
    </div>

    <script>
      let playerName, goal, balance;
      let priceHistory = [];
      let chart;
      let bitcoinHoldings = 0;
      let totalInvested = 0;
      let tradingHistory = [];
      const TOTAL_POINTS = 120; // 60 seconds before and after
      const UPDATE_INTERVAL = 1000; // Update every second

      // Load data from cookies
      function loadFromCookies() {
        playerName = getCookie("playerName") || "";
        goal = getCookie("goal") || "";
        balance = parseFloat(getCookie("balance")) || 0;
        bitcoinHoldings = parseFloat(getCookie("bitcoinHoldings")) || 0;
        totalInvested = parseFloat(getCookie("totalInvested")) || 0;
        tradingHistory = JSON.parse(getCookie("tradingHistory") || "[]");

        // Convert date strings back to Date objects in trading history
        tradingHistory = tradingHistory.map((t) => ({
          ...t,
          date: new Date(t.date),
        }));
      }

      // Save data to cookies
      function saveToCookies() {
        setCookie("playerName", playerName, 30);
        setCookie("goal", goal, 30);
        setCookie("balance", balance.toString(), 30);
        setCookie("bitcoinHoldings", bitcoinHoldings.toString(), 30);
        setCookie("totalInvested", totalInvested.toString(), 30);
        setCookie("tradingHistory", JSON.stringify(tradingHistory), 30);
      }

      // Cookie helper functions
      function setCookie(name, value, days) {
        const d = new Date();
        d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
        const expires = "expires=" + d.toUTCString();
        document.cookie = name + "=" + value + ";" + expires + ";path=/";
      }

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
      }

      // Wait for DOM to be fully loaded
      document.addEventListener("DOMContentLoaded", () => {
        loadFromCookies();

        // If we have saved data, restore the game
        if (playerName && goal) {
          document.getElementById("player-name").value = playerName;
          document.getElementById("welcome-screen").classList.add("hidden");
          document.getElementById("game-container").classList.remove("hidden");
          document.getElementById("name-display").textContent = playerName;
          document.getElementById("goal-display").textContent = goal;
          document.getElementById("balance-display").textContent =
            balance.toLocaleString();
          document.getElementById(
            "game-avatar"
          ).src = `https://api.dicebear.com/9.x/adventurer/svg?seed=${playerName}`;

          updateDisplays();
          updateHistoryDisplay();
          initializeChart();
          startBitcoinSimulation();
        }
      });

      function startGame(selectedGoal) {
        playerName = document.getElementById("player-name").value;
        if (!playerName) {
          alert("Please enter your name!");
          return;
        }

        goal = selectedGoal;
        switch (selectedGoal) {
          case "10K":
            balance = 1000;
            break;
          case "100K":
            balance = 5000;
            break;
          case "1M":
            balance = 10000;
            break;
        }

        document.getElementById("welcome-screen").classList.add("hidden");
        document.getElementById("game-container").classList.remove("hidden");
        document.getElementById("name-display").textContent = playerName;
        document.getElementById("goal-display").textContent = selectedGoal;
        document.getElementById("balance-display").textContent =
          balance.toLocaleString();
        document.getElementById(
          "game-avatar"
        ).src = `https://api.dicebear.com/9.x/adventurer/svg?seed=${playerName}`;

        updateProgress();
        saveToCookies();

        initializeChart();
        startBitcoinSimulation();
      }

      function updateProgress() {
        const goalAmount = parseInt(
          goal.replace("K", "000").replace("M", "000000")
        );
        const progress = (balance / goalAmount) * 100;
        document.getElementById("progress-fill").style.width =
          Math.min(100, progress) + "%";
        document.getElementById("current-amount").textContent =
          balance.toLocaleString();
      }

      function addToHistory(type, btcAmount, price, total, gain = null) {
        const transaction = {
          date: new Date(),
          type,
          btcAmount,
          price,
          total,
          gain,
        };
        tradingHistory.unshift(transaction);
        updateHistoryDisplay();
        saveToCookies();
      }

      function updateHistoryDisplay() {
        const tbody = document.getElementById("history-tbody");
        tbody.innerHTML = "";

        tradingHistory.forEach((transaction) => {
          const row = document.createElement("tr");
          const gainClass =
            transaction.gain > 0
              ? "gain-positive"
              : transaction.gain < 0
              ? "gain-negative"
              : "";

          row.innerHTML = `
            <td>${transaction.date.toLocaleString()}</td>
            <td>${transaction.type}</td>
            <td>${transaction.btcAmount.toFixed(4)}</td>
            <td>$${transaction.price.toLocaleString()}</td>
            <td>$${transaction.total.toLocaleString()}</td>
            <td class="${gainClass}">${
            transaction.gain !== null
              ? (transaction.gain > 0 ? "+" : "") +
                "$" +
                transaction.gain.toLocaleString()
              : "-"
          }</td>
          `;
          tbody.appendChild(row);
        });
      }

      function buyBitcoin() {
        const usdAmount = parseFloat(
          document.getElementById("buy-amount").value
        );
        const currentPrice = parseFloat(
          document
            .getElementById("current-price-display")
            .textContent.replace(/,/g, "")
        );

        if (isNaN(usdAmount) || usdAmount <= 0) {
          alert("Please enter a valid USD amount");
          return;
        }

        if (usdAmount > balance) {
          alert("Insufficient funds!");
          return;
        }

        const btcAmount = usdAmount / currentPrice;
        balance -= usdAmount;
        bitcoinHoldings += btcAmount;
        totalInvested += usdAmount;

        addToHistory("BUY", btcAmount, currentPrice, usdAmount);
        updateDisplays();
        saveToCookies();
      }

      function sellAllBitcoin() {
        if (bitcoinHoldings <= 0) {
          alert("You don't have any Bitcoin to sell!");
          return;
        }

        const currentPrice = parseFloat(
          document
            .getElementById("current-price-display")
            .textContent.replace(/,/g, "")
        );
        const totalValue = bitcoinHoldings * currentPrice;
        const gain = totalValue - totalInvested;
        balance += totalValue;

        addToHistory("SELL", bitcoinHoldings, currentPrice, totalValue, gain);

        bitcoinHoldings = 0;
        totalInvested = 0;
        updateDisplays();
        saveToCookies();
      }

      function updateDisplays() {
        const currentPrice = parseFloat(
          document
            .getElementById("current-price-display")
            .textContent.replace(/,/g, "")
        );
        const holdingsValue = bitcoinHoldings * currentPrice;
        const gainLoss = holdingsValue - totalInvested;

        document.getElementById("balance-display").textContent =
          balance.toLocaleString();
        document.getElementById("btc-holdings").textContent =
          bitcoinHoldings.toFixed(4);
        document.getElementById("holdings-value").textContent =
          holdingsValue.toFixed(2);
        document.getElementById("holdings-gain").textContent =
          "$" + (gainLoss >= 0 ? "+" : "") + gainLoss.toFixed(2);
        document.getElementById("sell-button").disabled = bitcoinHoldings <= 0;
        updateProgress();
        saveToCookies();
      }

      function initializeChart() {
        const ctx = document.getElementById("bitcoin-chart").getContext("2d");
        priceHistory = new Array(TOTAL_POINTS).fill(null);

        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Bitcoin Price",
                data: priceHistory,
                borderColor: "#f7931a",
                backgroundColor: "rgba(247, 147, 26, 0.1)",
                tension: 0.4,
                fill: true,
                spanGaps: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: {
                  color: "#fff",
                },
              },
            },
            scales: {
              y: {
                beginAtZero: false,
                grid: {
                  color: "#333",
                },
                ticks: {
                  color: "#fff",
                },
              },
              x: {
                grid: {
                  color: "#333",
                },
                ticks: {
                  color: "#fff",
                  callback: function (value) {
                    if (value === 60) return "Now";
                    const offset = value - 60;
                    return offset > 0 ? `+${offset}s` : `${offset}s`;
                  },
                },
              },
            },
          },
        });
      }

      async function getBitcoinPrice() {
        try {
          const response = await fetch(
            "https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT"
          );
          const data = await response.json();
          return parseFloat(data.price);
        } catch (error) {
          console.error("Error fetching Bitcoin price:", error);
          return null;
        }
      }

      async function startBitcoinSimulation() {
        let currentPrice = (await getBitcoinPrice()) || 30000;
        document.getElementById("current-price-display").textContent =
          currentPrice.toLocaleString();

        priceHistory[60] = currentPrice;

        setInterval(async () => {
          const newPrice = await getBitcoinPrice();
          if (newPrice) {
            currentPrice = newPrice;
            document.getElementById("current-price-display").textContent =
              currentPrice.toLocaleString();

            priceHistory.shift();
            priceHistory.push(null);
            priceHistory[60] = currentPrice;

            chart.data.labels = Array.from(
              { length: TOTAL_POINTS },
              (_, i) => i
            );
            chart.data.datasets[0].data = priceHistory;
            chart.update();

            updateDisplays();

            if (
              balance >=
              parseInt(goal.replace("K", "000").replace("M", "000000"))
            ) {
              alert("Congratulations! You've reached your goal! 🎉");
              // Clear cookies before reloading
              document.cookie.split(";").forEach(function (c) {
                document.cookie = c
                  .replace(/^ +/, "")
                  .replace(
                    /=.*/,
                    "=;expires=" + new Date().toUTCString() + ";path=/"
                  );
              });
              location.reload();
            }
          }
        }, UPDATE_INTERVAL);
      }
    </script>
  </body>
</html>
